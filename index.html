<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>RADAR V13.0 OMNI | Enterprise QC System</title>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@2.2.1/dist/chartjs-plugin-annotation.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
<script src="https://cdn.sheetjs.com/xlsx-0.19.3/package/dist/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">

<style>
/* --- THEME VARS --- */
:root {
  --bg-dark: #0f172a; --panel-dark: #1e293b; --border-dark: #334155;
  --text-main: #f1f5f9; --text-muted: #94a3b8;
  --primary: #3b82f6; --primary-hover: #2563eb;
  --success: #10b981; --warning: #f59e0b; --danger: #ef4444; --info: #06b6d4;
  --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.5);
}

* { box-sizing: border-box; margin: 0; padding: 0; outline: none; }
body { font-family: 'Roboto', sans-serif; background: var(--bg-dark); color: var(--text-main); height: 100vh; display: flex; overflow: hidden; }

/* --- SIDEBAR --- */
.sidebar { width: 280px; background: var(--panel-dark); border-right: 1px solid var(--border-dark); display: flex; flex-direction: column; z-index: 20; padding: 1.5rem; box-shadow: 5px 0 15px rgba(0,0,0,0.3); }
.brand { font-family: 'JetBrains Mono', monospace; font-size: 1.6rem; font-weight: 800; color: var(--primary); margin-bottom: 2rem; display: flex; align-items: center; gap: 12px; }
.nav-group { margin-bottom: 20px; }
.nav-title { font-size: 0.7rem; text-transform: uppercase; color: var(--text-muted); font-weight: 700; margin-bottom: 8px; letter-spacing: 1px; }
.nav-item { padding: 12px 15px; border-radius: 8px; cursor: pointer; color: var(--text-muted); transition: 0.2s; display: flex; align-items: center; gap: 12px; font-weight: 500; font-size: 0.9rem; margin-bottom: 4px; }
.nav-item:hover, .nav-item.active { background: rgba(59, 130, 246, 0.15); color: var(--primary); }
.nav-item i { width: 20px; text-align: center; }

/* --- PRODUCT CARD (SIDEBAR) --- */
.product-card { background: rgba(0,0,0,0.2); border: 1px solid var(--primary); border-radius: 8px; padding: 15px; margin-top: auto; }
.prod-label { font-size: 0.7rem; color: var(--text-muted); }
.prod-name { font-weight: 700; font-size: 1rem; color: var(--primary); margin: 4px 0; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.prod-spec { font-size: 0.8rem; color: #fff; font-family: 'JetBrains Mono'; }

/* --- MAIN CONTENT --- */
.main { flex: 1; padding: 25px; overflow-y: auto; position: relative; background: radial-gradient(circle at 90% 10%, #1e293b 0%, #0f172a 60%); }
.top-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; }
.operator-info { display: flex; align-items: center; gap: 10px; background: var(--panel-dark); padding: 8px 15px; border-radius: 30px; border: 1px solid var(--border-dark); cursor: pointer; }
.shift-badge { background: var(--warning); color: #000; font-weight: bold; padding: 5px 10px; border-radius: 4px; font-size: 0.8rem; }

/* --- BUTTONS --- */
.btn { padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; display: inline-flex; align-items: center; gap: 8px; font-size: 0.9rem; transition: 0.2s; }
.btn-primary { background: var(--primary); color: #fff; }
.btn-primary:hover { background: var(--primary-hover); box-shadow: 0 0 15px rgba(59, 130, 246, 0.4); }
.btn-secondary { background: transparent; border: 1px solid var(--border-dark); color: var(--text-muted); }
.btn-secondary:hover { border-color: var(--text-main); color: var(--text-main); }
.btn-manual { background: var(--info); color: #000; }

/* --- GRID SYSTEM --- */
.grid { display: grid; grid-template-columns: repeat(12, 1fr); gap: 20px; }
.card { background: var(--panel-dark); border: 1px solid var(--border-dark); border-radius: 12px; padding: 20px; box-shadow: var(--shadow); position: relative; overflow: hidden; }
.col-3 { grid-column: span 3; } .col-4 { grid-column: span 4; } .col-6 { grid-column: span 6; } .col-8 { grid-column: span 8; } .col-9 { grid-column: span 9; } .col-12 { grid-column: span 12; }

/* --- METRICS --- */
.metric-label { font-size: 0.8rem; color: var(--text-muted); text-transform: uppercase; font-weight: 600; letter-spacing: 0.5px; }
.metric-val { font-size: 2.2rem; font-weight: 800; font-family: 'JetBrains Mono'; margin: 10px 0; color: #fff; }
.status-pill { display: inline-block; padding: 4px 10px; border-radius: 20px; font-size: 0.75rem; font-weight: bold; }
.st-ok { background: rgba(16, 185, 129, 0.2); color: var(--success); }
.st-ng { background: rgba(239, 68, 68, 0.2); color: var(--danger); }
.st-warn { background: rgba(245, 158, 11, 0.2); color: var(--warning); }

/* --- HEATMAP --- */
.heatmap { display: grid; grid-template-columns: repeat(6, 1fr); gap: 10px; margin-top: 15px; }
.lane-box { background: rgba(255,255,255,0.03); border: 1px solid var(--border-dark); border-radius: 8px; padding: 15px 5px; text-align: center; position: relative; transition: 0.3s; }
.lane-box.alert { border-color: var(--danger); background: rgba(239, 68, 68, 0.1); animation: pulse-red 2s infinite; }
.lane-num { font-size: 0.7rem; color: var(--text-muted); position: absolute; top: 5px; left: 8px; }
.lane-avg { font-size: 1.2rem; font-weight: bold; }

/* --- TABLE --- */
.table-container { overflow-x: auto; border-radius: 8px; border: 1px solid var(--border-dark); }
table { width: 100%; border-collapse: collapse; font-family: 'JetBrains Mono', monospace; font-size: 0.85rem; }
th { text-align: left; padding: 12px 15px; background: rgba(0,0,0,0.2); color: var(--text-muted); font-weight: 600; border-bottom: 1px solid var(--border-dark); }
td { padding: 10px 15px; border-bottom: 1px solid var(--border-dark); color: #fff; }
tr:hover td { background: rgba(255,255,255,0.02); }
.txt-red { color: var(--danger); font-weight: bold; }

/* --- ANIMATION --- */
@keyframes pulse-red { 0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4); } 70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); } 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); } }

/* --- RESPONSIVE --- */
@media(max-width: 1200px) { .col-3, .col-4 { grid-column: span 6; } }
@media(max-width: 768px) { .sidebar { display: none; } .col-6, .col-8, .col-9 { grid-column: span 12; } }
</style>
</head>
<body>

<nav class="sidebar">
  <div class="brand">
    <i class="fas fa-layer-group"></i> RADAR V13
  </div>
  
  <div class="nav-group">
    <div class="nav-title">Monitoring</div>
    <div class="nav-item active" onclick="ui.page('dash')"><i class="fas fa-chart-pie"></i> Dashboard</div>
    <div class="nav-item" onclick="ui.page('data')"><i class="fas fa-table"></i> Data Logs</div>
    <div class="nav-item" onclick="ui.page('spc')"><i class="fas fa-chart-bar"></i> SPC Analysis</div>
  </div>

  <div class="nav-group">
    <div class="nav-title">Management</div>
    <div class="nav-item" onclick="app.productManager()"><i class="fas fa-box-open"></i> Products (SKU)</div>
    <div class="nav-item" onclick="app.operatorLogin()"><i class="fas fa-user-clock"></i> Ganti Operator</div>
  </div>

  <div class="nav-group">
    <div class="nav-title">Reports</div>
    <div class="nav-item" onclick="pdfGen.print()"><i class="fas fa-file-pdf"></i> Cetak PDQC-015</div>
    <div class="nav-item" onclick="app.exportExcel()"><i class="fas fa-file-excel"></i> Export Excel</div>
  </div>

  <div class="nav-group">
    <div class="nav-title">System</div>
    <div class="nav-item" onclick="app.resetSystem()" style="color:var(--danger)"><i class="fas fa-trash-alt"></i> Reset All Data</div>
  </div>

  <div class="product-card" id="sidebarProduct">
    <div class="prod-label">ACTIVE PRODUCT</div>
    <div class="prod-name">LOADING...</div>
    <div class="prod-spec">--</div>
  </div>
</nav>

<main class="main">
  <div class="top-bar">
    <div>
      <h2 style="font-weight: 300; margin-bottom: 5px;">Quality Control Center</h2>
      <div style="font-size: 0.85rem; color: var(--text-muted);" id="headerDate">System Ready</div>
    </div>
    <div style="display: flex; gap: 15px; align-items: center;">
      <div class="shift-badge" id="shiftBadge">SHIFT 1</div>
      <div class="operator-info" onclick="app.operatorLogin()">
        <i class="fas fa-user-circle"></i> <span id="opName">QC Operator</span>
      </div>
      <button class="btn btn-manual" onclick="app.manualInput()"><i class="fas fa-keyboard"></i> MANUAL</button>
      <button class="btn btn-primary" onclick="app.scanBatch()"><i class="fas fa-wifi"></i> SCAN SENSOR</button>
    </div>
  </div>

  <div id="v-dash" class="grid">
    <div class="card col-3">
      <div class="metric-label">Batch Average</div>
      <div class="metric-val" id="kpiAvg">--</div>
      <span class="status-pill st-ok" id="kpiAvgBadge">Target Range</span>
    </div>
    <div class="card col-3">
      <div class="metric-label">Reject (Shift)</div>
      <div class="metric-val" style="color:var(--danger)" id="kpiRej">0</div>
      <div style="font-size:0.8rem; color:var(--text-muted)">Pieces Out of Spec</div>
    </div>
    <div class="card col-3">
      <div class="metric-label">A/R Status</div>
      <div class="metric-val" style="color:var(--warning)" id="kpiAR">--</div>
      <div style="font-size:0.8rem; color:var(--text-muted)">Current Batch</div>
    </div>
    <div class="card col-3">
      <div class="metric-label">Capability (Cpk)</div>
      <div class="metric-val" style="color:var(--info)" id="kpiCpk">--</div>
      <div style="font-size:0.8rem; color:var(--text-muted)">Target > 1.33</div>
    </div>

    <div class="card col-4" style="min-height: 320px;">
      <div style="display:flex; justify-content:space-between;">
        <h3 style="font-size:1rem;">Lane Status (Realtime)</h3>
        <small style="color:var(--text-muted)">8 Active Lanes</small>
      </div>
      <div id="heatmapContainer" class="heatmap"></div>
    </div>

    <div class="card col-8">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
        <h3 style="font-size:1rem;">X-Bar Trend (Zoomed)</h3>
        <div style="font-size:0.75rem; color:var(--text-muted)">Range: Std Â± 2g</div>
      </div>
      <div style="height: 250px;">
        <canvas id="chartMain"></canvas>
      </div>
    </div>
  </div>

  <div id="v-data" class="card col-12" style="display:none;">
    <div style="display:flex; justify-content:space-between; margin-bottom:15px;">
      <h3>Production Data Log</h3>
      <button class="btn btn-secondary btn-sm" onclick="app.exportExcel()"><i class="fas fa-download"></i> Download CSV</button>
    </div>
    <div class="table-container">
      <table id="dataTable">
        <thead>
          <tr>
            <th>TIME</th><th>SHIFT</th><th>OPR</th><th>PATT</th>
            <th>L1</th><th>L2</th><th>L3</th><th>L4</th><th>L5</th><th>L6</th><th>L7</th><th>L8</th>
            <th>AVG</th><th>A/R</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <div id="v-spc" class="grid" style="display:none;">
    <div class="card col-6">
      <h3>Weight Histogram</h3>
      <div style="height:300px;"><canvas id="chartHisto"></canvas></div>
    </div>
    <div class="card col-6">
      <h3>Statistical Summary</h3>
      <table class="table" style="margin-top:20px;">
        <tr><td>Total Samples (N)</td><td id="statN" style="text-align:right; font-weight:bold;">0</td></tr>
        <tr><td>Mean</td><td id="statMean" style="text-align:right; font-weight:bold;">0</td></tr>
        <tr><td>Std Dev (Sigma)</td><td id="statSigma" style="text-align:right; font-weight:bold;">0</td></tr>
        <tr><td>Process Capability (Cp)</td><td id="statCp" style="text-align:right; font-weight:bold;">0</td></tr>
        <tr><td>Capability Index (Cpk)</td><td id="statCpkVal" style="text-align:right; font-weight:bold; color:var(--primary)">0</td></tr>
      </table>
    </div>
  </div>

</main>

<script>
// --- V13.0 CORE MODULES ---

// 1. DATA STORE & CONFIG
const db = {
  products: [
    { id: 1, name: "GSS-USA 6x5 DPL", std: 70.0, tol: 3.0, min: 67.0, max: 73.0 },
    { id: 2, name: "Indomie Goreng Reg", std: 85.0, tol: 4.0, min: 81.0, max: 89.0 },
    { id: 3, name: "Sarimi Isi 2", std: 110.0, tol: 5.0, min: 105.0, max: 115.0 }
  ],
  activeProdIndex: 0,
  operator: "QC Staff",
  logs: [] // Main Data Storage
};

// 2. MAIN APP CONTROLLER
const app = {
  init: () => {
    // Load from LocalStorage
    const savedDB = localStorage.getItem('radar_v13_db');
    if(savedDB) {
      const parsed = JSON.parse(savedDB);
      db.products = parsed.products || db.products;
      db.activeProdIndex = parsed.activeProdIndex || 0;
      db.operator = parsed.operator || "QC Staff";
      db.logs = parsed.logs || [];
    }
    
    // Setup UI
    ui.updateProductCard();
    ui.updateOperator();
    ui.detectShift();
    charts.init();
    ui.render();
    
    // Auto Shift Detect Loop
    setInterval(ui.detectShift, 60000);
  },

  save: () => localStorage.setItem('radar_v13_db', JSON.stringify(db)),

  getProd: () => db.products[db.activeProdIndex],

  // --- CORE LOGIC: SCANNING ---
  scanBatch: (manualData = null) => {
    const prod = app.getProd();
    const h = db.logs.length + 1;
    const isOdd = h % 2 !== 0;
    const pattern = isOdd ? "Ganjil" : "Genap";
    const counts = isOdd ? [3,3,3,3,2,2,2,2] : [2,2,2,2,3,3,3,3];
    
    let batch = {
      id: Date.now(),
      h: h,
      shift: ui.detectShift(),
      opr: db.operator,
      patt: pattern,
      lines: {},
      flat: [],
      rej: 0
    };

    // Use Manual Data OR Simulate Sensor
    for(let i=1; i<=12; i++) {
      batch.lines[i] = [];
      let n = (i<=8) ? counts[i-1] : 0;
      
      for(let k=0; k<n; k++) {
        let w;
        if(manualData && manualData[i] && manualData[i][k]) {
          w = manualData[i][k];
        } else {
          // Simulation Logic V12 (Zoom Friendly)
          let noise = (Math.random()-0.5) * (prod.tol * 0.6); 
          if(Math.random() > 0.95) noise = (Math.random()>0.5 ? prod.tol+0.5 : -(prod.tol+0.5)); // Outlier
          w = parseFloat((prod.std + noise).toFixed(1));
        }
        
        batch.lines[i].push(w);
        batch.flat.push(w);
        // STRICT REJECT LOGIC
        if(w < prod.min || w > prod.max) batch.rej++;
      }
    }

    // Calc Avg
    let sum = batch.flat.reduce((a,b)=>a+b,0);
    batch.avg = batch.flat.length ? parseFloat((sum/batch.flat.length).toFixed(1)) : 0;
    // A/R Logic
    batch.ar = (batch.rej >= 4 ? "R" : "A");

    db.logs.push(batch);
    app.save();
    ui.render();
    
    Swal.fire({
      icon: 'success', 
      title: 'Batch Captured', 
      text: `Avg: ${batch.avg}g | Status: ${batch.ar === 'A' ? 'RELEASE' : 'HOLD'}`,
      timer: 1500, showConfirmButton: false
    });
  },

  // --- FEATURE: MANUAL INPUT ---
  manualInput: () => {
    Swal.fire({
      title: 'Manual Input Mode',
      text: 'Simulasi Input Keypad aktif. Data acak akan digenerate sebagai contoh input manual.',
      icon: 'info',
      showCancelButton: true,
      confirmButtonText: 'Input Data'
    }).then((res) => {
      if(res.isConfirmed) app.scanBatch(); // For demo, we still randomize but flag it conceptually
    });
  },

  // --- FEATURE: PRODUCT MANAGER ---
  productManager: () => {
    const opts = db.products.map((p,i) => `<option value="${i}" ${i===db.activeProdIndex?'selected':''}>${p.name}</option>`).join('');
    
    Swal.fire({
      title: 'Product Management',
      html: `
        <select id="sw_prod_sel" class="swal2-input">${opts}</select>
        <div style="margin-top:10px; font-size:0.8rem; color:#aaa;">Pilih produk aktif atau tambah baru.</div>
      `,
      showDenyButton: true,
      denyButtonText: '+ Add New',
      confirmButtonText: 'Select Active',
    }).then((res) => {
      if(res.isConfirmed) {
        db.activeProdIndex = parseInt(document.getElementById('sw_prod_sel').value);
        app.save();
        ui.updateProductCard();
        charts.init(); // Reset chart limits
        ui.render();
        Swal.fire('Product Changed', `Active: ${app.getProd().name}`, 'success');
      } else if (res.isDenied) {
        app.addProductWizard();
      }
    });
  },

  addProductWizard: () => {
    Swal.fire({
      title: 'New Product SKU',
      html: `
        <input id="new_name" class="swal2-input" placeholder="Product Name">
        <input id="new_std" type="number" class="swal2-input" placeholder="Standard (g)">
        <input id="new_tol" type="number" class="swal2-input" placeholder="Tolerance (g)">
      `,
      confirmButtonText: 'Save',
      preConfirm: () => {
        return {
          name: document.getElementById('new_name').value,
          std: parseFloat(document.getElementById('new_std').value),
          tol: parseFloat(document.getElementById('new_tol').value)
        }
      }
    }).then((res) => {
      if(res.isConfirmed) {
        const p = res.value;
        if(!p.name || !p.std || !p.tol) return;
        p.id = db.products.length + 1;
        p.min = p.std - p.tol;
        p.max = p.std + p.tol;
        db.products.push(p);
        db.activeProdIndex = db.products.length - 1;
        app.save();
        ui.updateProductCard();
        Swal.fire('Saved', 'New product active.', 'success');
      }
    });
  },

  operatorLogin: () => {
    Swal.fire({
      title: 'Operator Login',
      input: 'text',
      inputValue: db.operator,
      text: 'Masukkan nama QC bertugas untuk Laporan.',
    }).then((res) => {
      if(res.value) {
        db.operator = res.value;
        app.save();
        ui.updateOperator();
      }
    });
  },

  resetSystem: () => {
    Swal.fire({
      title: 'Protected Action',
      input: 'password',
      inputLabel: 'Enter Admin PIN (1234)',
      showCancelButton: true
    }).then((res) => {
      if(res.value === '1234') {
        db.logs = [];
        app.save();
        location.reload();
      } else if (res.value) {
        Swal.fire('Error', 'Wrong PIN', 'error');
      }
    });
  },

  exportExcel: () => {
    const wb = XLSX.utils.book_new();
    let rows = [["TIME","SHIFT","OPERATOR","PATTERN","L1","L2","L3","L4","L5","L6","L7","L8","AVG","STATUS"]];
    db.logs.forEach(d => {
      rows.push([new Date(d.id).toLocaleTimeString(), d.shift, d.opr, d.patt, 
        d.lines[1].join(' '), d.lines[2].join(' '), d.lines[3].join(' '), d.lines[4].join(' '), 
        d.lines[5].join(' '), d.lines[6].join(' '), d.lines[7].join(' '), d.lines[8].join(' '), 
        d.avg, d.ar]);
    });
    XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(rows), "QC Data");
    XLSX.writeFile(wb, `RADAR_EXPORT_${new Date().toISOString().slice(0,10)}.xlsx`);
  }
};

// 3. UI HANDLER
const ui = {
  detectShift: () => {
    const h = new Date().getHours();
    let s = (h >= 7 && h < 15) ? "1" : (h >= 15 && h < 23) ? "2" : "3";
    document.getElementById('shiftBadge').innerText = `SHIFT ${s}`;
    document.getElementById('headerDate').innerText = new Date().toLocaleDateString('id-ID', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
    return s;
  },

  updateProductCard: () => {
    const p = app.getProd();
    document.querySelector('.prod-name').innerText = p.name;
    document.querySelector('.prod-spec').innerText = `${p.std}g (Min:${p.min} Max:${p.max})`;
  },

  updateOperator: () => {
    document.getElementById('opName').innerText = db.operator;
  },

  page: (id) => {
    document.getElementById('v-dash').style.display = id==='dash'?'grid':'none';
    document.getElementById('v-data').style.display = id==='data'?'block':'none';
    document.getElementById('v-spc').style.display = id==='spc'?'grid':'none';
    
    // Update nav active state
    document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
    event.currentTarget.classList.add('active');
  },

  render: () => {
    if(!db.logs.length) return;
    const last = db.logs[db.logs.length-1];
    const prod = app.getProd();

    // KPI
    document.getElementById('kpiAvg').innerText = last.avg;
    document.getElementById('kpiRej').innerText = last.rej;
    document.getElementById('kpiAR').innerText = `${last.rej}/${last.ar}`;
    document.getElementById('kpiAR').style.color = last.ar === 'R' ? 'var(--danger)' : 'var(--warning)';

    // Heatmap
    const hm = document.getElementById('heatmapContainer');
    hm.innerHTML = '';
    for(let i=1; i<=12; i++) {
      let vals = last.lines[i];
      let hasRej = vals.some(v => v < prod.min || v > prod.max);
      let avg = vals.length ? (vals.reduce((a,b)=>a+b,0)/vals.length).toFixed(1) : '-';
      hm.innerHTML += `<div class="lane-box ${hasRej?'alert':''}"><div class="lane-num">J${i}</div><div class="lane-avg">${avg}</div></div>`;
    }

    // Table
    const tbody = document.querySelector('#dataTable tbody');
    tbody.innerHTML = '';
    [...db.logs].reverse().forEach(d => {
      let cells = '';
      for(let i=1; i<=8; i++) {
        let txt = d.lines[i].map(x => `<span class="${(x<prod.min||x>prod.max)?'txt-red':''}">${x}</span>`).join(' ');
        cells += `<td>${txt}</td>`;
      }
      tbody.innerHTML += `<tr><td>${new Date(d.id).toLocaleTimeString()}</td><td>${d.shift}</td><td>${d.opr}</td><td>${d.patt}</td>${cells}<td style="font-weight:bold">${d.avg}</td><td class="${d.ar==='R'?'txt-red':''}">${d.rej}/${d.ar}</td></tr>`;
    });

    // Charts & SPC
    charts.update();
    charts.calcSPC();
  }
};

// 4. CHARTS & SPC
const charts = {
  main: null,
  histo: null,

  init: () => {
    const prod = app.getProd();
    // Trend Chart
    if(charts.main) charts.main.destroy();
    charts.main = new Chart(document.getElementById('chartMain'), {
      type: 'line',
      data: { labels: [], datasets: [{ label: 'Avg Weight', data: [], borderColor: '#3b82f6', tension: 0.3 }] },
      options: { 
        responsive:true, maintainAspectRatio:false, 
        scales: { y: { min: prod.std - (prod.tol*0.8), max: prod.std + (prod.tol*0.8), grid:{color:'#334155'} }, x: {display:false} },
        plugins: { legend: {display:false}, annotation: { annotations: {
          target: { type:'line', yMin:prod.std, yMax:prod.std, borderColor:'#10b981', borderDash:[5,5], borderWidth:1 }
        }}}
      }
    });

    // Histo Chart
    if(charts.histo) charts.histo.destroy();
    charts.histo = new Chart(document.getElementById('chartHisto'), {
      type: 'bar',
      data: { labels: [], datasets: [{ label: 'Frequency', data: [], backgroundColor: '#06b6d4' }] },
      options: { responsive:true, maintainAspectRatio:false, plugins: { legend: {display:false} } }
    });
  },

  update: () => {
    charts.main.data.labels = db.logs.map(d => `B${d.h}`);
    charts.main.data.datasets[0].data = db.logs.map(d => d.avg);
    charts.main.update();
  },

  calcSPC: () => {
    const all = db.logs.flatMap(d => d.flat);
    if(all.length < 5) return;
    const prod = app.getProd();

    // Stats
    const n = all.length;
    const mean = all.reduce((a,b)=>a+b,0)/n;
    const variance = all.reduce((a,b)=>a+Math.pow(b-mean,2),0)/n;
    const std = Math.sqrt(variance);
    
    // Cp Cpk
    const cp = (prod.max - prod.min) / (6*std);
    const cpu = (prod.max - mean) / (3*std);
    const cpl = (mean - prod.min) / (3*std);
    const cpk = Math.min(cpu, cpl);

    // DOM
    document.getElementById('statN').innerText = n;
    document.getElementById('statMean').innerText = mean.toFixed(2);
    document.getElementById('statSigma').innerText = std.toFixed(3);
    document.getElementById('statCp').innerText = cp.toFixed(2);
    document.getElementById('statCpkVal').innerText = cpk.toFixed(2);
    document.getElementById('kpiCpk').innerText = cpk.toFixed(2);

    // Histo Update
    const bins = {};
    const step = 0.5;
    for(let i=prod.min-1; i<=prod.max+1; i+=step) bins[i.toFixed(1)] = 0;
    all.forEach(v => {
      let k = (Math.round(v*2)/2).toFixed(1);
      if(bins[k] !== undefined) bins[k]++;
    });
    charts.histo.data.labels = Object.keys(bins);
    charts.histo.data.datasets[0].data = Object.values(bins);
    charts.histo.update();
  }
};

// 5. PDF ENGINE (V11 PRECISION)
const pdfGen = {
  print: () => {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF('l', 'mm', 'a4');
    const prod = app.getProd();

    doc.setFontSize(10); doc.setFont("helvetica", "bold");
    doc.text("PT INDOFOOD CBP SUKSES MAKMUR Tbk", 14, 10);
    doc.setFontSize(8); doc.setFont("helvetica", "normal");
    doc.text("DIVISI NOODLE - PABRIK CIBITUNG", 14, 15);
    doc.text("Kode Form: PDQC-015", 250, 10);
    
    doc.setFontSize(14); doc.setFont("helvetica", "bold");
    doc.text("LAPORAN MONITORING BERAT MI EX COOLING", 148, 25, {align:"center"});
    
    doc.setFontSize(9); doc.setFont("helvetica", "normal");
    doc.text(`Tanggal: ${new Date().toLocaleDateString()}`, 14, 35);
    doc.text(`Flavour: ${prod.name}`, 14, 40);
    doc.text(`Standar: ${prod.std}g (${prod.min} - ${prod.max})`, 230, 35);

    let body = [];
    db.logs.forEach(d => {
      let rows = [[], [], [], [], []];
      for(let r=0; r<5; r++) {
        if(r===0) {
          rows[r].push({content:String(d.h), rowSpan:5, styles:{valign:'middle'}}); 
          rows[r].push(String(r+1)); 
        } else {
          rows[r].push(String(r+1));
        }
      }
      for(let i=1; i<=12; i++) {
        let v = d.lines[i] || [];
        for(let r=0; r<5; r++) rows[r].push(v[r]!==undefined ? String(v[r]) : "");
      }
      rows[0].push({content:String(d.avg), rowSpan:5, styles:{valign:'middle'}});
      rows[0].push({content:`${d.rej}/${d.ar}`, rowSpan:5, styles:{valign:'middle'}});
      rows.forEach(r => body.push(r));
    });

    doc.autoTable({
      startY: 45,
      head: [
        [{content:'Jam', rowSpan:2}, {content:'No', rowSpan:2}, {content:'DATA PENIMBANGAN PER JALUR (gram)', colSpan:12, styles:{halign:'center'}}, {content:'Rata', rowSpan:2}, {content:'A/R', rowSpan:2}], 
        ['1','2','3','4','5','6','7','8','9','10','11','12']
      ],
      body: body,
      theme: 'grid',
      styles: { fontSize: 7, lineColor: [0,0,0], lineWidth: 0.1, textColor:[0,0,0], halign:'center', valign:'middle' },
      headStyles: { fillColor: [220, 220, 220], textColor: [0,0,0], fontStyle: 'bold', lineWidth: 0.1 },
      didParseCell: (data) => {
        if(data.section==='body' && data.column.index>=2 && data.column.index<=13) {
          let v = parseFloat(data.cell.raw);
          if(v && (v < prod.min || v > prod.max)) { data.cell.styles.textColor = [255,0,0]; data.cell.styles.fontStyle='bold'; }
        }
      }
    });

    let fy = doc.lastAutoTable.finalY + 10;
    doc.text(`Dibuat Oleh: ${db.operator}`, 180, fy+10);
    doc.text("Diketahui: SPV QC", 240, fy+10);
    doc.save(`PDQC015_${prod.name.replace(/ /g,'_')}.pdf`);
  },
};

// Start App
document.addEventListener('DOMContentLoaded', app.init);
</script>
</body>
</html>
