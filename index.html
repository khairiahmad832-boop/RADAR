<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>RADAR V8.0 HISTORY | QC System</title>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
<script src="https://cdn.sheetjs.com/xlsx-0.19.3/package/dist/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">

<style>
:root {
  --bg-body: #0f172a; --bg-panel: #1e293b; --bg-card: rgba(30, 41, 59, 0.7);
  --text-main: #f8fafc; --text-muted: #94a3b8;
  --primary: #3b82f6; --accent: #10b981; --danger: #ef4444; --warning: #f59e0b;
  --border: rgba(255,255,255,0.1);
}

[data-theme="light"] {
  --bg-body: #f1f5f9; --bg-panel: #ffffff; --bg-card: rgba(255, 255, 255, 0.9);
  --text-main: #0f172a; --text-muted: #64748b; --border: rgba(0,0,0,0.1);
}

* { margin:0; padding:0; box-sizing:border-box; transition: background 0.3s; }
body { font-family: 'Inter', sans-serif; background: var(--bg-body); color: var(--text-main); height: 100vh; display: flex; overflow: hidden; }

/* LAYOUT */
.sidebar { width: 280px; background: var(--bg-panel); border-right: 1px solid var(--border); padding: 1.5rem; display: flex; flex-direction: column; z-index: 20; box-shadow: 2px 0 10px rgba(0,0,0,0.2); }
.main { flex: 1; overflow-y: auto; padding: 2rem; position: relative; }
.backdrop { position: fixed; inset: 0; z-index: -1; background: radial-gradient(circle at 50% 10%, #1e293b 0%, #0f172a 100%); }

/* COMPONENT */
.logo { font-family: 'JetBrains Mono', monospace; font-size: 1.6rem; font-weight: 800; color: var(--primary); margin-bottom: 2rem; display: flex; align-items: center; gap: 10px; }
.nav-item { padding: 12px; margin-bottom: 5px; border-radius: 8px; cursor: pointer; color: var(--text-muted); font-weight: 500; display: flex; gap: 10px; align-items: center; }
.nav-item:hover, .nav-item.active { background: rgba(59, 130, 246, 0.1); color: var(--primary); }
.nav-head { font-size: 0.7rem; text-transform: uppercase; color: var(--text-muted); margin: 20px 0 5px; font-weight: 800; letter-spacing: 1px; }

.grid-dash { display: grid; grid-template-columns: repeat(4, 1fr); gap: 1.5rem; }
.card { background: var(--bg-card); border: 1px solid var(--border); border-radius: 12px; padding: 1.5rem; backdrop-filter: blur(12px); box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); }
.span-2 { grid-column: span 2; } .span-4 { grid-column: span 4; }

.kpi-val { font-size: 2.5rem; font-weight: 800; line-height: 1; }
.badge { padding: 4px 8px; border-radius: 4px; font-size: 0.75rem; font-weight: 700; }
.bg-ok { background: rgba(16, 185, 129, 0.2); color: var(--accent); }
.bg-ng { background: rgba(239, 68, 68, 0.2); color: var(--danger); }

/* HEATMAP */
.heatmap { display: grid; grid-template-columns: repeat(6, 1fr); gap: 8px; margin-top: 15px; }
.lane-box { aspect-ratio: 1.2; border-radius: 6px; display: flex; flex-direction: column; justify-content: center; align-items: center; font-size: 0.8rem; background: rgba(255,255,255,0.03); border: 1px solid var(--border); position: relative; }
.lane-val { font-weight: bold; font-size: 1rem; }
.lane-n { position: absolute; top: 2px; left: 4px; font-size: 0.6rem; opacity: 0.7; }

/* TABLE */
table { width: 100%; border-collapse: collapse; font-size: 0.8rem; }
th { text-align: left; padding: 10px; border-bottom: 2px solid var(--border); color: var(--text-muted); }
td { padding: 8px 10px; border-bottom: 1px solid var(--border); }

/* ANGKA WARNA */
.val-ok { color: var(--accent); }
.val-ng { color: var(--danger); font-weight: bold; }

/* BUTTONS */
.btn { border: none; padding: 10px 20px; border-radius: 6px; font-weight: 600; cursor: pointer; display: inline-flex; gap: 8px; align-items: center; }
.btn-p { background: var(--primary); color: #fff; }
.btn:hover { opacity: 0.9; transform: translateY(-1px); }

/* CHANGELOG LIST */
.changelog-list { text-align: left; max-height: 300px; overflow-y: auto; font-size: 0.85rem; line-height: 1.6; }
.ver-title { font-weight: bold; color: var(--primary); margin-top: 10px; border-bottom: 1px solid #444; padding-bottom: 2px; }
.ver-item { margin-left: 15px; position: relative; }
.ver-item::before { content: "â€¢"; position: absolute; left: -15px; color: var(--text-muted); }

</style>
</head>
<body>

<div class="backdrop"></div>

<nav class="sidebar">
  <div class="logo">
    <i class="fas fa-satellite-dish"></i> RADAR <span style="font-size:0.5em; color:var(--accent); margin-top:5px;">V8.0</span>
  </div>

  <div class="nav-head">MONITORING</div>
  <div class="nav-item active" onclick="app.setTab('dashboard')"><i class="fas fa-chart-pie"></i> Dashboard</div>
  <div class="nav-item" onclick="app.setTab('data')"><i class="fas fa-table"></i> Data Log (Detail)</div>

  <div class="nav-head">Laporan</div>
  <div class="nav-item" onclick="app.exportPDF()"><i class="fas fa-file-pdf"></i> Cetak PDQC-015</div>
  <div class="nav-item" onclick="app.exportExcel()"><i class="fas fa-file-excel"></i> Export Excel</div>

  <div class="nav-head">System</div>
  <div class="nav-item" onclick="app.showChangelog()"><i class="fas fa-history"></i> Version History</div>
  <div class="nav-item" onclick="app.toggleTheme()"><i class="fas fa-adjust"></i> Tema Terang/Gelap</div>
  <div class="nav-item" onclick="app.resetData()" style="color:var(--danger)"><i class="fas fa-trash"></i> Reset Data</div>

  <div style="margin-top:auto;">
    <div class="card" style="padding:15px; font-size:0.8rem; border:1px solid var(--primary);">
      <div style="color:var(--text-muted)">Active Flavour</div>
      <div style="font-weight:bold; font-size:0.9rem; color:var(--primary)">GSS-USA 6x5 DPL</div>
      <div style="font-size:0.7rem; opacity:0.7; margin-top:5px; border-top:1px solid #444; padding-top:5px;">
        Std: 70g (67 - 73g)
      </div>
    </div>
  </div>
</nav>

<main class="main">
  <header style="display:flex; justify-content:space-between; align-items:center; margin-bottom:2rem;">
    <div>
      <h1 style="font-size:1.8rem; font-weight:800;">QC Sampling Center</h1>
      <div style="color:var(--text-muted);">Logic: Min 67.0 | Max 73.0 (67.3 = OK)</div>
    </div>
    <button class="btn btn-p" onclick="app.simulate()"><i class="fas fa-sync"></i> SCAN BATCH (20 DATA)</button>
  </header>

  <div id="view-dashboard" class="grid-dash">
    <div class="card">
      <div style="color:var(--text-muted)">Rata-rata Terkini</div>
      <div class="kpi-val" id="kpiAvg">--</div>
      <div class="badge bg-ok" id="kpiStatus">READY</div>
    </div>
    <div class="card">
      <div style="color:var(--text-muted)">Reject Shift Ini</div>
      <div class="kpi-val" style="color:var(--danger)" id="kpiRej">0</div>
      <div style="font-size:0.8rem;">Pcs Out of Spec</div>
    </div>
    <div class="card">
      <div style="color:var(--text-muted)">Status A/R</div>
      <div class="kpi-val" style="color:var(--warning)" id="kpiAR">--</div>
      <div style="font-size:0.8rem;">(Limit: Reject < 4)</div>
    </div>
    <div class="card">
      <div style="color:var(--text-muted)">Shift Extremes</div>
      <div style="font-size:0.85rem; margin-top:10px;">
        Max: <b id="statMax" class="val-ok">--</b>
      </div>
      <div style="font-size:0.85rem;">
        Min: <b id="statMin" class="val-ok">--</b>
      </div>
    </div>

    <div class="card span-2" style="min-height:300px;">
      <h3>Status 12 Jalur (Real-time)</h3>
      <p style="font-size:0.75rem; color:var(--text-muted); margin-bottom:10px;">Merah = Ada sample reject di jalur ini. Angka = Rata-rata.</p>
      <div id="heatmapContainer" class="heatmap"></div>
    </div>

    <div class="card span-2">
      <h3>Grafik Tren Berat (X-Bar)</h3>
      <div style="height:250px;">
        <canvas id="chartMain"></canvas>
      </div>
    </div>
  </div>

  <div id="view-data" class="card span-4" style="display:none;">
    <h3 style="margin-bottom:1rem;">Database Sampling (Detail)</h3>
    <div style="overflow-x:auto;">
      <table id="dataTable">
        <thead>
          <tr>
            <th>Jam</th>
            <th>Pola</th>
            <th>J1</th><th>J2</th><th>J3</th><th>J4</th>
            <th>J5</th><th>J6</th><th>J7</th><th>J8</th>
            <th>Avg</th>
            <th>A/R</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>
</main>

<script>
const app = {
  cfg: {
    std: 70.0,
    tol: 3.0,
    min: 67.0, // Batas bawah AMAN
    max: 73.0, // Batas atas AMAN
  },
  data: [],
  charts: {},

  init: () => {
    const saved = localStorage.getItem('radar_v8_data');
    if(saved) app.data = JSON.parse(saved);
    app.initCharts();
    app.refreshUI();
  },

  simulate: () => {
    const hourIdx = app.data.length + 1;
    const isOdd = hourIdx % 2 !== 0;
    let patternName = isOdd ? "Ganjil" : "Genap";
    let counts = isOdd ? [3,3,3,3, 2,2,2,2] : [2,2,2,2, 3,3,3,3];
    while(counts.length < 12) counts.push(0);

    let batch = {
      id: Date.now(),
      hour: hourIdx,
      pattern: patternName,
      lines: {}, 
      flat: [],
      rejectCount: 0
    };

    for(let l=0; l<12; l++) {
      let lineNum = l+1;
      batch.lines[lineNum] = [];
      let numSamples = counts[l];
      
      for(let s=0; s<numSamples; s++) {
        // Berat Random (Dominan 67-73)
        let noise = (Math.random() - 0.5) * 4.0; 
        if(Math.random() > 0.9) noise = (Math.random() > 0.5 ? 4.5 : -4.5); // Sesekali Reject
        
        // Simulasi Khusus untuk membuktikan 67.3 Aman
        if(Math.random() > 0.95) noise = -2.7; // 70 - 2.7 = 67.3
        
        let w = parseFloat((app.cfg.std + noise).toFixed(1));
        batch.lines[lineNum].push(w);
        batch.flat.push(w);

        // LOGIKA REJECT
        // Reject jika < 67 ATAU > 73
        // 67.0, 67.3, 73.0 ADALAH AMAN
        if(w < app.cfg.min || w > app.cfg.max) {
          batch.rejectCount++;
        }
      }
    }

    let sum = batch.flat.reduce((a,b)=>a+b,0);
    batch.avg = batch.flat.length ? (sum / batch.flat.length).toFixed(1) : 0;
    
    // A/R
    let statusChar = batch.rejectCount >= 4 ? "R" : "A";
    batch.arDisplay = `${batch.rejectCount}/${statusChar}`;

    app.data.push(batch);
    app.save();
    app.refreshUI();
    
    Swal.fire({
      icon: 'success', title: `Batch Jam ${hourIdx}`,
      text: `Status: ${batch.arDisplay}`,
      timer: 1000, showConfirmButton: false
    });
  },

  refreshUI: () => {
    if(app.data.length === 0) {
      app.renderHeatmap(null);
      return;
    }
    const last = app.data[app.data.length-1];
    
    document.getElementById('kpiAvg').innerText = last.avg;
    document.getElementById('kpiRej').innerText = last.rejectCount;
    document.getElementById('kpiAR').innerText = last.arDisplay;
    document.getElementById('kpiStatus').innerText = last.rejectCount >= 4 ? "HOLD" : "RELEASE";
    document.getElementById('kpiStatus').className = `badge ${last.rejectCount >= 4 ? 'bg-ng' : 'bg-ok'}`;

    // Stats Shift
    let allRaw = app.data.flatMap(b => b.flat);
    if(allRaw.length > 0) {
      document.getElementById('statMax').innerText = Math.max(...allRaw);
      document.getElementById('statMin').innerText = Math.min(...allRaw);
    }

    app.renderHeatmap(last);
    app.updateCharts(); 
    app.renderTable();
  },

  renderHeatmap: (batch) => {
    const container = document.getElementById('heatmapContainer');
    container.innerHTML = '';
    for(let i=1; i<=12; i++) {
      let content = '-';
      let style = '';
      if(batch && batch.lines[i] && batch.lines[i].length > 0) {
        let sum = batch.lines[i].reduce((a,b)=>a+b,0);
        let avg = (sum / batch.lines[i].length).toFixed(1);
        content = avg;
        // Cek jika ada reject di jalur ini
        let hasReject = batch.lines[i].some(w => w < app.cfg.min || w > app.cfg.max);
        style = hasReject ? 'border-color:var(--danger); background:rgba(239,68,68,0.2);' : 'border-color:var(--accent); background:rgba(16,185,129,0.1);';
      }
      container.innerHTML += `<div class="lane-box" style="${style}"><div class="lane-n">J${i}</div><div class="lane-val">${content}</div></div>`;
    }
  },

  renderTable: () => {
    const tbody = document.querySelector('#dataTable tbody');
    tbody.innerHTML = '';
    [...app.data].reverse().forEach(b => {
      let cols = '';
      for(let i=1; i<=8; i++) {
        // RENDER ANGKA INDIVIDUAL DENGAN WARNA
        let valHTML = b.lines[i].map(w => {
           let isReject = w < app.cfg.min || w > app.cfg.max;
           let colorClass = isReject ? 'val-ng' : 'val-ok';
           return `<span class="${colorClass}">${w}</span>`;
        }).join(', ');
        
        cols += `<td>${valHTML}</td>`;
      }
      tbody.innerHTML += `<tr><td>${b.hour}</td><td>${b.pattern}</td>${cols}<td style="font-weight:bold">${b.avg}</td><td style="font-weight:bold; color:${b.rejectCount>=4?'var(--danger)':'var(--accent)'}">${b.arDisplay}</td></tr>`;
    });
  },

  updateCharts: () => {
    const labels = app.data.map(b => `J${b.hour}`);
    app.charts.trend.data.labels = labels;
    app.charts.trend.data.datasets[0].data = app.data.map(b => b.avg);
    app.charts.trend.update();
  },

  // --- PDF ENGINE ---
  exportPDF: () => {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF('l', 'mm', 'a4');

    doc.setFontSize(10); doc.setFont("helvetica", "bold");
    doc.text("PT INDOFOOD CBP SUKSES MAKMUR Tbk", 14, 10);
    doc.setFontSize(8); doc.setFont("helvetica", "normal");
    doc.text("DIVISI NOODLE - PABRIK CIBITUNG", 14, 15);
    doc.text("Kode Form: PDQC-015", 250, 10);
    
    doc.setFontSize(14); doc.setFont("helvetica", "bold");
    doc.text("LAPORAN MONITORING BERAT MI EX COOLING", 148, 25, {align:"center"});
    
    doc.setFontSize(9); doc.setFont("helvetica", "normal");
    doc.text(`Tanggal: ${new Date().toLocaleDateString()}`, 14, 35);
    doc.text(`Flavour: GSS-USA 6x5 DPL`, 14, 40);
    doc.text(`Standar: 70g (67 - 73)`, 230, 35);

    let body = [];
    app.data.forEach(b => {
      let rowsForHour = [[], [], [], [], []];
      for(let r=0; r<5; r++) {
        if(r===0) {
          rowsForHour[r].push({content: String(b.hour), rowSpan: 5, styles:{valign:'middle'}});
          rowsForHour[r].push(String(r+1)); 
        } else {
          rowsForHour[r].push(String(r+1));
        }
      }

      for(let i=1; i<=12; i++) {
        let samples = b.lines[i] || [];
        for(let r=0; r<5; r++) {
          let val = samples[r] !== undefined ? String(samples[r]) : "";
          rowsForHour[r].push(val);
        }
      }
      rowsForHour[0].push({content: String(b.avg), rowSpan: 5, styles:{valign:'middle'}});
      rowsForHour[0].push({content: String(b.arDisplay), rowSpan: 5, styles:{valign:'middle'}});
      rowsForHour.forEach(r => body.push(r));
    });

    doc.autoTable({
      startY: 45,
      head: [[
        {content: 'Jam', styles:{valign:'middle'}},
        {content: 'No', styles:{valign:'middle'}},
        {content: 'DATA BERAT PER JALUR (gram)', colSpan: 12, styles:{halign:'center'}},
        {content: 'Avg', styles:{valign:'middle'}},
        {content: 'A / R', styles:{valign:'middle'}}
      ], ['','','1','2','3','4','5','6','7','8','9','10','11','12','','']],
      body: body,
      theme: 'grid',
      styles: { fontSize: 8, cellPadding: 1, lineColor: [0,0,0], lineWidth: 0.1, textColor: [0,0,0], halign: 'center', valign: 'middle' },
      headStyles: { fillColor: [220, 220, 220], textColor: [0,0,0], fontStyle: 'bold' },
      didParseCell: function(data) {
        if (data.section === 'body' && data.column.index >= 2 && data.column.index <= 13) {
          let text = data.cell.raw; 
          if (text && text !== "") {
            let val = parseFloat(text);
            if(val < app.cfg.min || val > app.cfg.max) {
              data.cell.styles.textColor = [255, 0, 0];
              data.cell.styles.fontStyle = 'bold';
            }
          }
        }
        if (data.section === 'body' && data.column.index === 15) {
           let content = typeof data.cell.raw === 'object' ? data.cell.raw.content : data.cell.raw;
           if(content && content.includes('/R')) {
             data.cell.styles.textColor = [255, 0, 0];
             data.cell.styles.fontStyle = 'bold';
           }
        }
      }
    });

    let fy = doc.lastAutoTable.finalY + 5;
    let allRaw = app.data.flatMap(b => b.flat);
    let allAvgs = app.data.map(b => parseFloat(b.avg));
    if(allRaw.length > 0) {
      let sMax = Math.max(...allRaw);
      let sMin = Math.min(...allRaw);
      let sAvg = (allAvgs.reduce((a,b)=>a+b,0) / allAvgs.length).toFixed(1);
      doc.setFontSize(8); doc.setFont("helvetica", "bold");
      doc.text(`SUMMARY SHIFT:`, 14, fy + 5);
      doc.setFont("helvetica", "normal");
      doc.text(`Berat Tertinggi: ${sMax}`, 14, fy + 10);
      doc.text(`Berat Terendah: ${sMin}`, 60, fy + 10);
      doc.text(`Rata-rata Shift: ${sAvg}`, 110, fy + 10);
    }
    doc.text("Dibuat Oleh: QC Field", 180, fy + 10);
    doc.text("Diketahui: SPV QC", 240, fy + 10);
    doc.save(`PDQC015_HISTORY_${Date.now()}.pdf`);
  },

  // --- CHANGELOG MODAL ---
  showChangelog: () => {
    Swal.fire({
      title: 'RADAR System Evolution',
      html: `
        <div class="changelog-list">
          <div class="ver-title">V1.0 - BASIC</div>
          <div class="ver-item">Basic Sampling System (Mobile/ESP32).</div>
          <div class="ver-item">Pola Ganjil/Genap Awal (33332222).</div>
          
          <div class="ver-title">V2.0 - PRO</div>
          <div class="ver-item">Web-based Dashboard.</div>
          <div class="ver-item">Fitur Six Sigma (Cp, Cpk) & Histogram.</div>
          <div class="ver-item">LocalStorage Database (Anti-Hilang).</div>

          <div class="ver-title">V3.0 - ULTIMATE</div>
          <div class="ver-item">Adaptive PDF (Layout 12 Jalur Baku).</div>
          <div class="ver-item">Indikator Merah untuk Berat <67 atau >73.</div>

          <div class="ver-title">V4.0 - PRECISION</div>
          <div class="ver-item">Logika A/R Baru (Reject < 4 = A, >= 4 = R).</div>
          <div class="ver-item">PDF Layout Grid 5 Baris (Rapi).</div>

          <div class="ver-title">V5.0 - PLATINUM</div>
          <div class="ver-item">Penggabungan Fitur Analytics V2 + Presisi PDF V4.</div>
          <div class="ver-item">Summary Shift (Max, Min, Avg) di Footer PDF.</div>

          <div class="ver-title">V6.0 - FINAL</div>
          <div class="ver-item">Perbaikan Garis (Border) pada setiap sel PDF.</div>
          <div class="ver-item">Perbaikan Logika Merah (Strict Out of Range).</div>

          <div class="ver-title">V7.0 - PERFECTED</div>
          <div class="ver-item">Visual Dashboard (Warna Angka vs Warna Kotak).</div>
          <div class="ver-item">Fix Validasi: 67.3 dianggap AMAN (Hijau).</div>
          
          <div class="ver-title">V8.0 - HISTORY (CURRENT)</div>
          <div class="ver-item">Penambahan Menu Changelog/History.</div>
          <div class="ver-item">Penyempurnaan Stabilitas Sistem.</div>
        </div>
      `,
      confirmButtonText: 'Tutup',
      width: '600px'
    });
  },

  exportExcel: () => {
    const wb = XLSX.utils.book_new();
    let wsData = [ ["PT INDOFOOD CBP"], ["DATA QC RADAR V8.0"], ["Jam", "Pola", "J1", "J2", "J3", "J4", "J5", "J6", "J7", "J8", "Avg", "A/R"] ];
    app.data.forEach(b => {
      wsData.push([ b.hour, b.pattern, b.lines[1].join(' '), b.lines[2].join(' '), b.lines[3].join(' '), b.lines[4].join(' '), b.lines[5].join(' '), b.lines[6].join(' '), b.lines[7].join(' '), b.lines[8].join(' '), b.avg, b.arDisplay ]);
    });
    const ws = XLSX.utils.aoa_to_sheet(wsData);
    XLSX.utils.book_append_sheet(wb, ws, "Data");
    XLSX.writeFile(wb, "RADAR_Export.xlsx");
  },

  initCharts: () => {
    app.charts.trend = new Chart(document.getElementById('chartMain'), {
      type: 'line', data: { labels: [], datasets: [ { label: 'Avg', data: [], borderColor: '#3b82f6', tension:0.3 }, { label: 'Max (73)', data: [], borderColor: '#ef4444', borderDash:[5,5], pointRadius:0 }, { label: 'Min (67)', data: [], borderColor: '#ef4444', borderDash:[5,5], pointRadius:0 } ] }, options: { responsive:true, maintainAspectRatio:false, scales:{y:{min:65, max:75}} }
    });
  },
  
  save: () => localStorage.setItem('radar_v8_data', JSON.stringify(app.data)),
  resetData: () => { Swal.fire({title:'Hapus Data?', icon:'warning', showCancelButton:true}).then(r=>{ if(r.isConfirmed) { app.data=[]; app.save(); location.reload(); } }) },
  toggleTheme: () => { const b = document.body; b.hasAttribute('data-theme') ? b.removeAttribute('data-theme') : b.setAttribute('data-theme','light'); },
  setTab: (t) => { document.getElementById('view-dashboard').style.display = t==='dashboard'?'grid':'none'; document.getElementById('view-data').style.display = t==='data'?'block':'none'; }
};

document.addEventListener('DOMContentLoaded', app.init);
</script>
</body>
</html>
