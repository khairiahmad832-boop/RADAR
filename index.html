<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>RADAR SYSTEM | QC Monitoring</title>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
<script src="https://cdn.sheetjs.com/xlsx-0.19.3/package/dist/xlsx.full.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">

<style>
:root {
  --bg-dark: #0f172a;
  --bg-card: rgba(30, 41, 59, 0.7);
  --primary: #0ea5e9;
  --accent: #10b981;
  --danger: #ef4444;
  --text: #f1f5f9;
  --text-muted: #94a3b8;
  --border: rgba(255,255,255,0.1);
}

* { margin: 0; padding: 0; box-sizing: border-box; }
body { font-family: 'Inter', sans-serif; background: var(--bg-dark); color: var(--text); min-height: 100vh; overflow-x: hidden; }

/* LAYOUT */
.app-container { display: flex; height: 100vh; }
.sidebar { width: 260px; background: #020617; border-right: 1px solid var(--border); display: flex; flex-direction: column; padding: 1.5rem; z-index: 50; }
.main-content { flex: 1; overflow-y: auto; padding: 2rem; position: relative; }
.main-bg { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; background: radial-gradient(circle at 50% 10%, #1e293b 0%, #0f172a 100%); }

/* LOGO & MENU */
.logo { font-family: 'JetBrains Mono', monospace; font-size: 1.5rem; font-weight: 800; color: var(--primary); margin-bottom: 2rem; display: flex; align-items: center; gap: 10px; }
.menu-item { padding: 12px 15px; border-radius: 8px; color: var(--text-muted); cursor: pointer; transition: 0.2s; display: flex; align-items: center; gap: 12px; margin-bottom: 5px; font-weight: 500; }
.menu-item:hover, .menu-item.active { background: rgba(14, 165, 233, 0.15); color: var(--primary); }
.menu-title { font-size: 0.75rem; text-transform: uppercase; color: #475569; margin: 20px 0 10px; letter-spacing: 1px; font-weight: 700; }

/* GRID & CARDS */
.grid { display: grid; grid-template-columns: repeat(12, 1fr); gap: 1.5rem; }
.card { background: var(--bg-card); border: 1px solid var(--border); border-radius: 16px; padding: 1.5rem; backdrop-filter: blur(10px); position: relative; }

/* RADAR ANIMATION */
.radar-box { height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; }
.radar-circle { width: 120px; height: 120px; border: 2px solid rgba(14, 165, 233, 0.3); border-radius: 50%; position: relative; background: radial-gradient(circle, rgba(14,165,233,0.1) 0%, transparent 70%); }
.radar-scan { position: absolute; top: 0; left: 0; width: 100%; height: 100%; border-radius: 50%; background: conic-gradient(from 0deg, transparent 0deg, rgba(14, 165, 233, 0.5) 60deg, transparent 60deg); animation: scan 2s linear infinite; }

/* TABLE & TERMINAL */
.table-container { overflow-x: auto; }
table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
th, td { padding: 10px; text-align: left; border-bottom: 1px solid var(--border); }
th { color: var(--text-muted); font-weight: 600; }
.status-badge { padding: 4px 8px; border-radius: 4px; font-size: 0.7rem; font-weight: 700; }
.status-ok { background: rgba(16, 185, 129, 0.2); color: var(--accent); }
.status-ng { background: rgba(239, 68, 68, 0.2); color: var(--danger); }
.terminal { background: #000; font-family: 'JetBrains Mono', monospace; font-size: 0.75rem; padding: 1rem; border-radius: 8px; height: 200px; overflow-y: auto; color: #33ff00; border: 1px solid #333; }

/* BUTTONS */
.btn { padding: 8px 16px; border-radius: 6px; border: none; font-weight: 600; cursor: pointer; display: inline-flex; align-items: center; gap: 8px; transition: 0.2s; }
.btn-primary { background: var(--primary); color: #fff; }
.btn-primary:hover { background: #0284c7; }
.btn-outline { background: transparent; border: 1px solid var(--border); color: var(--text); }
.btn-outline:hover { background: rgba(255,255,255,0.05); }

@keyframes scan { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
</style>
</head>
<body>

<div class="main-bg"></div>

<div class="app-container">
  <aside class="sidebar">
    <div class="logo"><i class="fas fa-satellite-dish"></i> RADAR</div>
    
    <div class="menu-title">Menu</div>
    <div class="menu-item active" onclick="switchTab('dashboard')"><i class="fas fa-chart-pie"></i> Dashboard</div>
    <div class="menu-item" onclick="switchTab('table')"><i class="fas fa-table"></i> Data Log</div>
    
    <div class="menu-title">Export</div>
    <div class="menu-item" onclick="exportPDF()"><i class="fas fa-file-pdf"></i> Laporan PDF</div>
    <div class="menu-item" onclick="exportExcel()"><i class="fas fa-file-excel"></i> Laporan Excel</div>
    
    <div class="menu-title">System</div>
    <div class="menu-item" onclick="toggleSettings()"><i class="fas fa-sliders-h"></i> Settings</div>
    
    <div style="margin-top: auto;">
      <div class="card" style="padding: 12px; background: rgba(0,0,0,0.3);">
        <div style="font-size: 0.7rem; color: var(--text-muted);">Active Flavour</div>
        <div style="font-weight: 700; font-size: 0.9rem; color: var(--accent); margin-bottom:5px;" id="dispFlavor">GSS-USA 6x5 DPL</div>
        <div style="font-size: 0.7rem; color: var(--text-muted); border-top:1px solid rgba(255,255,255,0.1); padding-top:5px;">
          Std: <span id="dispStd">70</span>g | Tol: Â±<span id="dispTol">3</span>g
        </div>
      </div>
    </div>
  </aside>

  <main class="main-content">
    <header style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
      <div>
        <h2 style="font-weight: 800; font-size: 1.5rem;">QC Monitoring Dashboard</h2>
        <p style="color: var(--text-muted); font-size: 0.9rem;">Real-time Sampling System</p>
      </div>
      <button class="btn btn-primary" onclick="simulateData()"><i class="fas fa-sync"></i> Simulate 20 Samples</button>
    </header>

    <div id="tab-dashboard" class="grid">
      <div class="card" style="grid-column: span 3;">
        <div style="color: var(--text-muted); font-size: 0.8rem;">Rata-rata Batch Ini</div>
        <div style="font-size: 2rem; font-weight: 800; margin: 5px 0;" id="kpiAvg">--</div>
        <div class="status-badge status-ok" id="kpiStatus">WAITING</div>
      </div>
      <div class="card" style="grid-column: span 3;">
        <div style="color: var(--text-muted); font-size: 0.8rem;">Pola Sampling</div>
        <div style="font-size: 1.5rem; font-weight: 800; margin: 5px 0; color: var(--primary);" id="dispPattern">--</div>
        <div style="font-size: 0.7rem; opacity: 0.7;">Jalur 1-8</div>
      </div>

      <div class="card" style="grid-column: span 6; display: flex; align-items: center; justify-content: space-between;">
        <div>
          <h3>RADAR SCANNING</h3>
          <p style="color: var(--text-muted); font-size: 0.8rem; margin-top:5px;">Mengambil 20 data dari 8 jalur...</p>
        </div>
        <div class="radar-box"><div class="radar-circle"><div class="radar-scan"></div></div></div>
      </div>

      <div class="card" style="grid-column: span 8; height: 320px;">
        <canvas id="mainChart"></canvas>
      </div>

      <div class="card" style="grid-column: span 4; height: 320px;">
        <div style="margin-bottom:10px; font-weight:bold;">Live Data Stream</div>
        <div class="terminal" id="terminalLog">
          <div style="opacity:0.5">> System Initialized...</div>
          <div style="opacity:0.5">> Std: 70g (67-73g)</div>
        </div>
      </div>
    </div>

    <div id="tab-table" class="card" style="display: none;">
      <h3>Data Log (Batch 20 Samples)</h3>
      <div class="table-container">
        <table id="dataTable">
          <thead>
            <tr>
              <th>Jam</th>
              <th>Pola</th>
              <th>Detail 20 Data (Line:Berat)</th>
              <th>Avg</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

  </main>
</div>

<script>
// --- KONFIGURASI ---
let CONFIG = {
  flavor: "GSS-USA 6x5 DPL",
  std: 70.0,
  tol: 3.0,
  line: "16",
  shift: "1"
};

let appData = {
  samples: [],
  hourCounter: 1 // Mulai Jam ke-1
};

// --- INIT ---
document.addEventListener('DOMContentLoaded', () => {
  initChart();
  updateConfigUI();
});

function updateConfigUI() {
  document.getElementById('dispFlavor').innerText = CONFIG.flavor;
  document.getElementById('dispStd').innerText = CONFIG.std;
  document.getElementById('dispTol').innerText = CONFIG.tol;
}

function switchTab(tab) {
  document.getElementById('tab-dashboard').style.display = tab === 'dashboard' ? 'grid' : 'none';
  document.getElementById('tab-table').style.display = tab === 'table' ? 'block' : 'none';
  document.querySelectorAll('.menu-item').forEach(el => el.classList.remove('active'));
  event.currentTarget.classList.add('active');
}

function log(msg) {
  const term = document.getElementById('terminalLog');
  term.innerHTML += `<div>> ${msg}</div>`;
  term.scrollTop = term.scrollHeight;
}

// --- CHART ---
let mainChart;
function initChart() {
  const ctx = document.getElementById('mainChart').getContext('2d');
  mainChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: [],
      datasets: [
        { label: 'Rata-rata', data: [], borderColor: '#0ea5e9', tension: 0.4 },
        { label: 'Max (73g)', data: [], borderColor: '#ef4444', borderDash: [5,5], pointRadius:0 },
        { label: 'Min (67g)', data: [], borderColor: '#ef4444', borderDash: [5,5], pointRadius:0 }
      ]
    },
    options: {
      responsive: true, maintainAspectRatio: false,
      plugins: { legend: { display: false } },
      scales: { y: { min: 65, max: 75 }, x: { display: false } }
    }
  });
}

// --- SIMULASI CERDAS (ROTASI SAMPLING) ---
function simulateData() {
  const isOddHour = appData.hourCounter % 2 !== 0; // Ganjil (1,3,5) vs Genap (2,4,6)
  
  // LOGIKA ROTASI
  // Ganjil: Jalur 1-4 (3 sample), Jalur 5-8 (2 sample)
  // Genap : Jalur 1-4 (2 sample), Jalur 5-8 (3 sample)
  const patternName = isOddHour ? "POLA A (3-3-3-3 | 2-2-2-2)" : "POLA B (2-2-2-2 | 3-3-3-3)";
  const counts = isOddHour ? [3,3,3,3,2,2,2,2] : [2,2,2,2,3,3,3,3];
  
  let batchData = {
    id: Date.now(),
    hour: appData.hourCounter,
    pattern: patternName,
    raw: [], // Menyimpan {line: 1, weight: 70.1}
    flatWeights: [] // Hanya berat untuk perhitungan
  };

  log(`Start Batch Jam ${appData.hourCounter} - ${patternName}`);

  // Generate 20 Data
  for (let lane = 0; lane < 8; lane++) {
    let sampleCount = counts[lane];
    for (let s = 0; s < sampleCount; s++) {
      // Random weight 68.5 - 71.5 (Normal) sesekali outlier
      let noise = (Math.random() - 0.5) * 3; // +/- 1.5g variasi
      let w = (CONFIG.std + noise).toFixed(1);
      
      // Simpan
      batchData.raw.push({ line: lane + 1, weight: w });
      batchData.flatWeights.push(parseFloat(w));
    }
  }

  // Hitung Statistik
  let sum = batchData.flatWeights.reduce((a, b) => a + b, 0);
  batchData.avg = (sum / 20).toFixed(1);
  batchData.status = (batchData.avg >= (CONFIG.std - CONFIG.tol) && batchData.avg <= (CONFIG.std + CONFIG.tol)) ? "OK" : "REJECT";

  // Simpan ke Memori Aplikasi
  appData.samples.push(batchData);
  appData.hourCounter++;

  // Update UI
  updateDashboard(batchData);
  updateTable(batchData);
}

function updateDashboard(batch) {
  document.getElementById('kpiAvg').innerText = batch.avg + " g";
  const badge = document.getElementById('kpiStatus');
  badge.innerText = batch.status;
  badge.className = `status-badge ${batch.status === 'OK' ? 'status-ok' : 'status-ng'}`;
  document.getElementById('dispPattern').innerText = batch.pattern.split('(')[0];

  // Update Chart
  mainChart.data.labels.push(`Jam ${batch.hour}`);
  mainChart.data.datasets[0].data.push(batch.avg);
  mainChart.data.datasets[1].data.push(CONFIG.std + CONFIG.tol);
  mainChart.data.datasets[2].data.push(CONFIG.std - CONFIG.tol);
  
  if (mainChart.data.labels.length > 10) {
    mainChart.data.labels.shift();
    mainChart.data.datasets.forEach(d => d.data.shift());
  }
  mainChart.update();
  
  log(`Batch Complete. Avg: ${batch.avg}g | Status: ${batch.status}`);
}

function updateTable(batch) {
  const tbody = document.querySelector('#dataTable tbody');
  // Format string data mentah agar ringkas: "L1:70.1, L1:70.2..."
  let detailStr = batch.raw.map(d => `L${d.line}:${d.weight}`).join(', ');
  
  const row = `
    <tr>
      <td>${batch.hour}</td>
      <td>${batch.pattern.split('(')[1].replace(')','')}</td>
      <td style="font-size:0.75rem; color:#aaa;">${detailStr}</td>
      <td style="font-weight:bold; color:var(--primary)">${batch.avg}</td>
      <td><span class="status-badge ${batch.status === 'OK' ? 'status-ok' : 'status-ng'}">${batch.status}</span></td>
    </tr>
  `;
  tbody.insertAdjacentHTML('afterbegin', row);
}

// --- PDF EXPORT (PDQC-015 UPDATED) ---
function exportPDF() {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF('l', 'mm', 'a4');

  // HEADER
  doc.setFontSize(10); doc.setFont("helvetica", "bold");
  doc.text("PT INDOFOOD CBP SUKSES MAKMUR Tbk", 14, 10);
  doc.setFontSize(8); doc.setFont("helvetica", "normal");
  doc.text("DIVISI NOODLE - PABRIK CIBITUNG", 14, 15);
  doc.text("Kode Form: PDQC-015", 250, 10);

  doc.setFontSize(14); doc.setFont("helvetica", "bold");
  doc.text("LAPORAN MONITORING BERAT MI EX COOLING", 148, 25, {align: "center"});

  doc.setFontSize(10); doc.setFont("helvetica", "normal");
  doc.text(`Tanggal: ${new Date().toLocaleDateString()}`, 14, 35);
  doc.text(`Flavour: ${CONFIG.flavor}`, 14, 40); // New Feature
  doc.text(`Standar: ${CONFIG.std}g (Min ${CONFIG.std - CONFIG.tol} - Max ${CONFIG.std + CONFIG.tol})`, 200, 35);

  // DATA MAPPING (20 Raw Data listed sequentially)
  let bodyData = [];
  appData.samples.forEach(b => {
    // Karena tabel kertas terbatas, kita tampilkan 20 data dalam string atau array panjang
    // Disini kita tampilkan 10 data pertama di baris 1, 10 data sisa di baris 2
    let row1 = [b.hour, "1-10", ...b.flatWeights.slice(0, 10), b.avg, b.status];
    let row2 = ["", "11-20", ...b.flatWeights.slice(10, 20), "", ""];
    
    bodyData.push(row1);
    bodyData.push(row2);
    // Spacer
    bodyData.push(['','','','','','','','','','','','','','']); 
  });

  doc.autoTable({
    startY: 45,
    head: [[
      {content: 'Jam', styles: {halign: 'center'}},
      {content: 'No', styles: {halign: 'center'}},
      {content: 'DATA BERAT (20 Sampel)', colSpan: 10, styles: {halign: 'center'}},
      {content: 'Rata2', styles: {halign: 'center'}},
      {content: 'Status', styles: {halign: 'center'}}
    ]],
    body: bodyData,
    theme: 'grid',
    styles: { fontSize: 8, cellPadding: 1, lineColor: [0,0,0], lineWidth: 0.1 },
    headStyles: { fillColor: [220, 220, 220], textColor: [0,0,0] }
  });

  // FOOTER
  let finalY = doc.lastAutoTable.finalY + 10;
  doc.text("Dibuat oleh: QC Field", 20, finalY);
  doc.text("Diketahui: SPV QC", 200, finalY);

  doc.save(`Laporan_RADAR_${new Date().getTime()}.pdf`);
}

// --- EXCEL EXPORT ---
function exportExcel() {
  if (appData.samples.length === 0) return Swal.fire("Info", "Belum ada data", "info");
  
  const wb = XLSX.utils.book_new();
  let wsData = [
    ["PT INDOFOOD CBP SUKSES MAKMUR Tbk"],
    ["LAPORAN MONITORING BERAT MI"],
    ["Flavour", CONFIG.flavor],
    ["Standar", CONFIG.std, "Toleransi", CONFIG.tol],
    [""],
    ["Jam", "Pola", "S1", "S2", "S3", "S4", "S5", "S6", "S7", "S8", "S9", "S10", "S11", "S12", "S13", "S14", "S15", "S16", "S17", "S18", "S19", "S20", "Rata-rata", "Status"]
  ];

  appData.samples.forEach(b => {
    wsData.push([
      b.hour, b.pattern,
      ...b.flatWeights,
      b.avg, b.status
    ]);
  });

  const ws = XLSX.utils.aoa_to_sheet(wsData);
  XLSX.utils.book_append_sheet(wb, ws, "Data QC");
  XLSX.writeFile(wb, "RADAR_Data_Log.xlsx");
}

function toggleSettings() {
  Swal.fire({
    title: 'System Settings',
    html: `
      <label>Flavour Name</label>
      <input id="sw-flavor" class="swal2-input" value="${CONFIG.flavor}">
      <label>Standard Weight (g)</label>
      <input id="sw-std" type="number" class="swal2-input" value="${CONFIG.std}">
      <label>Tolerance (g)</label>
      <input id="sw-tol" type="number" class="swal2-input" value="${CONFIG.tol}">
    `,
    preConfirm: () => {
      return {
        flavor: document.getElementById('sw-flavor').value,
        std: parseFloat(document.getElementById('sw-std').value),
        tol: parseFloat(document.getElementById('sw-tol').value)
      }
    }
  }).then((res) => {
    if (res.isConfirmed) {
      CONFIG.flavor = res.value.flavor;
      CONFIG.std = res.value.std;
      CONFIG.tol = res.value.tol;
      updateConfigUI();
      Swal.fire("Saved", "Settings updated successfully", "success");
    }
  });
}
</script>
</body>
</html>
